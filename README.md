# LifeControl
Multiplatform app for life

1) Что такое alembic
2) Что такое пагинация
3) 

# Financier API Backend

REST API бэкенд для мультиплатформенного приложения "Финансист".
Написан на Python с использованием FastAPI, SQLAlchemy и PostgreSQL.

## Технологический стек

- **Бэкенд:** Python 3.11+, FastAPI
- **База данных:** PostgreSQL
- **ORM:** SQLAlchemy (асинхронный режим с `asyncpg`)
- **Валидация данных:** Pydantic
- **Миграции БД:** Alembic
- **Аутентификация:** JWT (OAuth2 Password Flow)
- **Тестирование:** Pytest, HTTPX
- **Развертывание:** Docker, Docker Compose

## Запуск проекта

### 1. Подготовка окружения

- Убедитесь, что у вас установлен Docker и Docker Compose.
- Скопируйте файл с примером переменных окружения:
  ```bash
  cp .env.example .env


### Как запустить (Этап 1)

1.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

2.  **Настройте базу данных:** Убедитесь, что у вас запущен PostgreSQL и создана база данных (например, `financier`), а также пользователь с правами.

3.  **Создайте `.env` файл:** Скопируйте ` .env.example` в `.env` и заполните его вашими данными для подключения к БД и `SECRET_KEY`.

4.  **Примените миграции:**
    *   Сначала убедитесь, что alembic видит ваши модели. Выполните:
        ```bash
        alembic revision --autogenerate -m "Initial migration"
        ```
    *   Эта команда создаст файл миграции в `alembic/versions`. Проверьте его содержимое.
    *   Затем примените миграцию к вашей базе данных:
        ```bash
        alembic upgrade head
        ```
    *   Ваши таблицы будут созданы в PostgreSQL.

5.  **Запустите API сервер:**
    ```bash
    uvicorn app.main:app --reload
    ```

6.  **Проверьте API:**
    *   Откройте в браузере `http://127.0.0.1:8000/docs`. Вы увидите интерактивную документацию Swagger UI.
    *   Используйте эндпоинт `POST /api/v1/users/register` для создания нового пользователя.
    *   Используйте `POST /api/v1/auth/token` для получения JWT токена.
    *   Скопируйте полученный токен, нажмите на кнопку "Authorize" в Swagger, вставьте токен в формате `Bearer <your_token>` и попробуйте выполнить запрос к `GET /api/v1/users/me`. Вы должны получить данные своего пользователя.



---



Отлично! Мы подошли к заключительному этапу. Все функциональные требования реализованы, и теперь наша задача — упаковать приложение, написать тесты и подготовить его к развертыванию.

**Этап 5: Финализация и развертывание**

На этом этапе я подготовил:
1.  **Базовые тесты с `pytest`:** Написаны тесты для ключевых эндпоинтов, проверяющие как успешные сценарии, так и обработку ошибок (например, попытка доступа без прав). Это критически важно для дальнейшей поддержки и разработки.
2.  **`Dockerfile`:** Создан файл для сборки Docker-образа нашего FastAPI-приложения.
3.  **`docker-compose.yml`:** Написан файл для легкого запуска всего стека (приложение + база данных PostgreSQL) одной командой.
4.  **`README.md`:** Добавлен файл с инструкциями по запуску проекта.

---

### Объяснение ключевых решений (Этап 5)

1.  **Тестирование (`tests/`):**
    *   **Структура:** Тесты вынесены в отдельную директорию `tests/`, что является стандартной практикой.
    *   **Изолированная БД:** Для тестов используется отдельная база данных (имя задается через переменные окружения), чтобы не затрагивать данные для разработки. Файл `docker-compose.override.yml` как раз и служит для подмены этих переменных при запуске тестов.
    *   **Фикстуры `pytest`:** Созданы фикстуры (например, `db_session`, `client`, `test_user`) для подготовки окружения перед каждым тестом (создание сессии БД, тестового клиента API, тестовых пользователей). Это позволяет писать тесты чисто и без дублирования кода.
    *   **Асинхронность:** Тесты написаны с использованием `pytest-asyncio` и `httpx.AsyncClient` для корректной работы с асинхронным кодом FastAPI.

2.  **Контейнеризация (`Dockerfile`):**
    *   **Multi-stage build:** Используется двухэтапная сборка. На первом этапе (`builder`) устанавливаются все зависимости, включая те, что нужны для компиляции (если бы они были). На втором, финальном, этапе (`final`) копируются только необходимые для запуска приложения файлы и установленные пакеты. Это позволяет создавать очень маленькие и безопасные production-образы.
    *   **Пользователь без root-прав:** Приложение в контейнере запускается от имени специально созданного пользователя `nonroot`, а не от `root`. Это золотой стандарт безопасности контейнеризации.

3.  **Оркестрация (`docker-compose.yml`):**
    *   **Два сервиса:** Определены два сервиса: `db` (PostgreSQL) и `api` (наше приложение).
    *   **Зависимости:** `api` зависит от `db` (`depends_on`), что гарантирует запуск контейнера с базой данных перед запуском API.
    *   **`healthcheck`:** Для сервиса `db` добавлен `healthcheck`, который проверяет готовность PostgreSQL принимать подключения. Сервис `api` дождется, пока `db` станет `healthy`, прежде чем стартовать. Это решает классическую проблему "API стартовал быстрее, чем БД".
    *   **Сеть и вольюмы:** Сервисы находятся в одной Docker-сети, что позволяет им общаться по именам (`db`). Для данных PostgreSQL используется именованный вольюм (`postgres_data`), чтобы данные не терялись при перезапуске контейнеров.
    *   **Переменные окружения:** Конфигурация передается в контейнеры через `env_file`, что позволяет легко менять настройки без пересборки образа.

---

### Код проекта (Финальная версия)

Ниже представлена **полная структура и код всех файлов проекта**.

#### Финальная структура проекта

```
financier-backend/
├── alembic/
│   ├── versions/
│   │   └── ..._initial_migration.py
│   ├── env.py
│   └── script.py.mako
├── app/
│   ├── api/
│   │   └── v1/
│   │       ├── api.py
│   │       ├── deps.py
│   │       └── endpoints/
│   │           ├── admin.py
│   │           ├── auth.py
│   │           ├── dashboard.py
│   │           ├── locations.py
│   │           ├── records.py
│   │           ├── spheres.py
│   │           └── users.py
│   ├── core/
│   │   ├── config.py
│   │   └── security.py
│   ├── crud/
│   │   ├── base.py
│   │   ├── dashboard.py
│   │   ├── location.py
│   │   ├── accounting_record.py
│   │   ├── sphere.py
│   │   └── user.py
│   ├── db/
│   │   ├── base.py
│   │   └── session.py
│   ├── models/
│   │   ├── accounting_record.py
│   │   ├── base_class.py
│   │   ├── location.py
│   │   ├── sphere.py
│   │   └── user.py
│   ├── schemas/
│   │   ├── accounting_record.py
│   │   ├── dashboard.py
│   │   ├── location.py
│   │   ├── sphere.py
│   │   ├── token.py
│   │   ├── user.py
│   │   └── utils.py
│   └── main.py
├── tests/
│   ├── api/
│   │   └── v1/
│   │       ├── test_login.py
│   │       └── test_spheres.py
│   ├── conftest.py
│   └── utils/
│       └── user.py
├── .env
├── .env.example
├── alembic.ini
├── docker-compose.override.yml
├── docker-compose.yml
├── Dockerfile
├── README.md
└── requirements.txt
```

---
#### Файлы с кодом (только новые или значительно измененные)


**`README.md`**
```markdown
# Financier API Backend

REST API бэкенд для мультиплатформенного приложения "Финансист".
Написан на Python с использованием FastAPI, SQLAlchemy и PostgreSQL.

## Технологический стек

- **Бэкенд:** Python 3.11+, FastAPI
- **База данных:** PostgreSQL
- **ORM:** SQLAlchemy (асинхронный режим с `asyncpg`)
- **Валидация данных:** Pydantic
- **Миграции БД:** Alembic
- **Аутентификация:** JWT (OAuth2 Password Flow)
- **Тестирование:** Pytest, HTTPX
- **Развертывание:** Docker, Docker Compose

## Запуск проекта

### 1. Подготовка окружения

- Убедитесь, что у вас установлен Docker и Docker Compose.
- Скопируйте файл с примером переменных окружения:
  ```bash
  cp .env.example .env
  ```
- Отредактируйте `.env` файл, указав свои данные, особенно `POSTGRES_PASSWORD` и `SECRET_KEY`.

### 2. Запуск с помощью Docker Compose

Это предпочтительный способ для разработки и продакшена. Он поднимет контейнер с API и контейнер с базой данных PostgreSQL.

```bash
docker-compose up -d --build
```

- `-d` запускает контейнеры в фоновом режиме.
- `--build` принудительно пересобирает образ API, если в коде были изменения.

После запуска API будет доступен по адресу `http://localhost:8000`.
Интерактивная документация (Swagger UI) доступна по адресу `http://localhost:8000/docs`.

### 3. Применение миграций БД

При первом запуске или после изменения моделей данных (`app/models`) необходимо применить миграции.

Сначала выполните команду внутри запущенного контейнера `api`, чтобы сгенерировать файл миграции:
```bash
docker-compose exec api alembic revision --autogenerate -m "Your migration message"
```

Затем примените миграцию к базе данных:
```bash
docker-compose exec api alembic upgrade head
```

### 4. Остановка проекта

```bash
docker-compose down
```

Чтобы остановить и удалить вольюм с данными БД (внимание, все данные будут потеряны!):
```bash
docker-compose down -v
```

## Тестирование

Для запуска тестов используется отдельный `docker-compose.override.yml`, который подменяет базу данных на тестовую.

```bash
docker-compose -f docker-compose.yml -f docker-compose.override.yml up -d
```

После запуска контейнеров, выполните тесты:
```bash
docker-compose exec api pytest
```
```
